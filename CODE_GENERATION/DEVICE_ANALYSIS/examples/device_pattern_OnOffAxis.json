{
  "schema_version": "1.0.2",
  "metadata": {
    "fb_name": "OnOffAxis",
    "version": "1.0.2",
    "author": "ZM",
    "device_family": "motion",
    "device_type": "linear_onoff",
    "analyzed_at": "2024-12-26T10:30:00Z",
    "source_files": {
      "fb_scl": "/path/to/OnOffAxis.scl",
      "udt_path": "/path/to/OnOffAxis/UDT/"
    },
    "portability_gate": {
      "status": "PASS",
      "violations": [],
      "notes": "No physical I/O, AT mapping, or hardcoded DB detected"
    }
  },
  "contract": {
    "input": {
      "command_udt": [
        {
          "name": "OOAx_Ctrl",
          "category": "command_udt",
          "source_file": "OOAx_Ctrl.xml",
          "fields": [
            {
              "name": "SafeStop",
              "type": "Bool",
              "mandatory": true
            },
            {
              "name": "Rst",
              "type": "Bool"
            },
            {
              "name": "Homing",
              "type": "Bool"
            },
            {
              "name": "MovePlus",
              "type": "Bool"
            },
            {
              "name": "MoveMinus",
              "type": "Bool"
            },
            {
              "name": "MoveAbsolute",
              "type": "Bool"
            },
            {
              "name": "Target",
              "type": "LReal"
            }
          ]
        }
      ],
      "config_udt": [
        {
          "name": "OOAx_Config",
          "category": "config_udt",
          "fields": [
            {
              "name": "limitMinus",
              "type": "LReal",
              "default": 0.0
            },
            {
              "name": "limitPlus",
              "type": "LReal",
              "default": 100.0
            },
            {
              "name": "ToleranceWindow",
              "type": "LReal",
              "default": 0.5
            },
            {
              "name": "Backlash",
              "type": "LReal",
              "default": 0.0
            }
          ]
        }
      ],
      "logical_inputs": [
        {
          "name": "HwLsMinus",
          "type": "Bool",
          "description": "Hardware limit switch minus (from safety logic, not physical I/O)"
        },
        {
          "name": "HwLsPlus",
          "type": "Bool",
          "description": "Hardware limit switch plus (from safety logic)"
        },
        {
          "name": "HwLsZero",
          "type": "Bool",
          "description": "Hardware zero reference (from safety logic)"
        }
      ]
    },
    "output": {
      "status_udt": [
        {
          "name": "OOAx_Sts",
          "category": "status_udt",
          "fields": [
            {
              "name": "AlarmPresence",
              "type": "Bool"
            },
            {
              "name": "StandStill",
              "type": "Bool"
            },
            {
              "name": "Homed",
              "type": "Bool"
            },
            {
              "name": "InPosition",
              "type": "Bool"
            },
            {
              "name": "ActualPosition",
              "type": "LReal"
            },
            {
              "name": "ActualSpeed",
              "type": "LReal"
            }
          ]
        }
      ],
      "logical_outputs": [
        {
          "name": "ActorCtrl.CmdMinus",
          "type": "Bool",
          "description": "Commands to motor driver (logical)"
        },
        {
          "name": "ActorCtrl.CmdPlus",
          "type": "Bool",
          "description": "Commands to motor driver (logical)"
        },
        {
          "name": "ActorCtrl.CmdLowSpeed",
          "type": "Bool",
          "description": "Commands to motor driver (logical)"
        },
        {
          "name": "ActorCtrl.CmdMediumSpeed",
          "type": "Bool",
          "description": "Commands to motor driver (logical)"
        },
        {
          "name": "ActorCtrl.CmdHighSpeed",
          "type": "Bool",
          "description": "Commands to motor driver (logical)"
        }
      ]
    },
    "inout": {
      "interfaces": [
        {
          "name": "PosFbk_ITF",
          "udt": "PosFbk_ITF",
          "description": "Position feedback interface",
          "retain": false,
          "ownership": "internal"
        },
        {
          "name": "AxisHomed",
          "type": "Bool",
          "description": "Persistent homing status",
          "retain": true,
          "ownership": "shared",
          "storage_hint": "External DB or global tag"
        }
      ]
    }
  },
  "logic": {
    "state_machine": {
      "type": "struct_pattern",
      "states": [
        "Idle",
        "Homing",
        "MoveMinus",
        "MovePlus",
        "MoveAbsolute"
      ],
      "mutual_exclusion": "Only ONE Request can be active at a time"
    },
    "key_algorithms": [
      {
        "name": "Backlash Compensation",
        "formula": "IF Backlash > 0 THEN Target := Position + Backlash",
        "implementation": "Two-stage move: overshoot then return"
      },
      {
        "name": "Speed Ramping",
        "formula": "LOW < PreEndLowSpeed | MEDIUM < PreEndMedSpeed | HIGH otherwise",
        "implementation": "Distance-based speed selection"
      },
      {
        "name": "Velocity Filtering",
        "formula": "ActualVelocity += decayFct * (actualSpeedWithSign - ActualVelocity)",
        "implementation": "Exponential filter with configurable time constant"
      }
    ]
  },
  "patterns": {
    "command_status": {
      "pattern": "Permitted->Request->Cmd->Done",
      "confidence": "HIGH",
      "evidence": "Homing.Permitted := NOT (Alarms OR Other.Request); Homing.Request := AxisCtrl.Homing AND Homing.Permitted"
    },
    "alarm_handling": {
      "pattern": "Trigger->Latch->Reset",
      "confidence": "HIGH",
      "evidence": "IF trigger THEN alarm := TRUE; IF reset THEN alarm := FALSE"
    },
    "native_functions": {
      "timers": [
        "tonStandstill",
        "tonStopInWindow",
        "tonChangeDirection",
        "tonTargetTimeout"
      ],
      "edge_detection": "manual",
      "motion_control": [],
      "math": [
        "ABS",
        "MAX",
        "MIN"
      ]
    }
  },
  "anti_patterns": [
    {
      "id": "AP001",
      "type": "manual_edge_detection",
      "severity": "MEDIUM",
      "file": "PosFbk_BaumerEAL580.scl",
      "line": 205,
      "code": "startPreset := Cmd AND NOT auxOs",
      "rule": "use_native_triggers",
      "impact": "Code verbosity, non-standard implementation",
      "suggested_fix": "VAR rtrigPreset : R_TRIG; END_VAR; rtrigPreset(CLK := Cmd, Q => startPreset);"
    }
  ],
  "dependencies": {
    "fb_called": [
      "PosFbk_BaumerEAL580"
    ],
    "custom_udts": [
      "OOAx_Ctrl",
      "OOAx_Config",
      "OOAx_Sts",
      "OOAx_Alr",
      "OOAx_Wng",
      "PosFbk_ITF"
    ],
    "external_devices": []
  },
  "constraints": {
    "portability_compliant": true,
    "multi_instance_safe": true,
    "notes": "Fully portable - no project-specific dependencies. RETAIN managed externally via AxisHomed parameter."
  },
  "configuration": {
    "example_config": {
      "limitMinus": 0.0,
      "limitPlus": 1000.0,
      "ToleranceWindow": 1.0,
      "Backlash": 2.0,
      "PreEndLowSpeed": 50.0,
      "PreEndMedSpeed": 200.0,
      "StandstillVelocity": 0.1,
      "StandStillDelay": 100,
      "ToleranceWindowDelay": 100
    },
    "validation_rules": [
      "limitPlus > limitMinus",
      "ToleranceWindow > 0",
      "PreEndLowSpeed < PreEndMedSpeed",
      "StandstillVelocity >= 0",
      "All timeouts > 0"
    ]
  }
}
