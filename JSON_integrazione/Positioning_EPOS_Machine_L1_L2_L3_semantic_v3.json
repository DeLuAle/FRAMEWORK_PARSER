{
  "meta": {
    "analysis_scope": "L1_SinaPos + L2_Positioning_EPOS_Machine",
    "version": "3.0",
    "analysis_date": "2026-01-07",
    "physical_model": "Positioning system using Sinamics S120 internal Basic Positioner (EPOS). The PLC acts as a commander/sequencer, not a trajectory generator.",
    "key_features": [
      "Drive Intelligence - Trajectory generation happens inside the S120 Drive",
      "Standard Interface - Usos Siemens SinaPos (FB284) for control",
      "Direct Homing - Supports direct writing of position to drive parameters (P2599/P2507) for calibrating Absolute Encoders",
      "Modulo support - Handles rotary axis limits via modulo arithmetic",
      "Mechanical Abstraction - Calculates Reduction Ratio to convert RPM/LU to Engineering Units",
      "Configuration Alignment - Usos PLC-side Config constants (P2571/P2580 etc) to scale Telegram commands, assuming alignment with Drive Parameterization"
    ]
  },
  "Preconditions": {
    "Required_Inputs": {
      "L3_Machine_List": "List of L3/L4 machine instances and their call blocks",
      "L3_CIn_Mapping": "Mapping for Manager/ExtEnable/Config/DSI and any HMI manual commands",
      "L3_COut_Aggregation": "Which COut signals must be aggregated and where they are consumed",
      "Safety_Inputs": "AreaInterface, ZSI/DSI signals and any interlocks"
    },
    "Question_Gate": {
      "If_Missing": [
        "Stop and ask for the missing inputs before generating L3 integration."
      ],
      "Minimum_Questions": [
        "Which L3/L4 machine instances are present and what are their call block names?",
        "Which Manager/ExtEnable/Config/DSI fields are used for this machine type?",
        "Which COut signals must be aggregated in L3?",
        "Which safety/area signals (AreaInterface, ZSI/DSI) must be wired?"
      ]
    }
  },
  "Parameter_Management": {
    "description": "Specific handling of S120 Acyclic Parameters (Read/Write) within the FB logic.",
    "Acyclic_Writes": {
      "Purpose": "Usod exclusively for 'Direct Homing' / 'Preset' sequence, to permanently set the mechanical position of Absolute Encoders.",
      "Sequence": [
        "1. Write P2599 (Reference Point Coordinate) := Target Position",
        "2. Write P2507 (Absolute Encoder Adjustment) := 2 (Calibrate)",
        "3. Read P2507 until value is 3 (Adjusted)",
        "4. Write P0971 (Save Parameters) := 1 (Save to ROM)",
        "5. Read P0971 until value is 0 (Finished)"
      ]
    },
    "Cyclic_Control": {
      "description": "Dynamics and Limits are NOT written acyclically but controlled via Telegram 111 (SinaPos Inputs).",
      "Mappings": {
        "Velocity": "Scaled relative to Config.MaxVel_S120_P2571",
        "OverAcc": "Scaled relative to Config.MaxAcc_S120_P2572 (Sent as % override)",
        "OverDec": "Scaled relative to Config.MaxDec_S120_P2573 (Sent as % override)"
      }
    }
  },
  "L1_SinaPos": {
    "description": "Standard Siemens Block (FB284) for controlling S120 Basic Positioner via Telegram 111.",
    "Modes_Used": {
      "Mode_1": "Relative Positioning",
      "Mode_2": "Absolute Positioning",
      "Mode_4": "Homing (Active/Passive)",
      "Mode_5": "Set Home Position",
      "Mode_7": "Jog"
    },
    "Inputs": {
      "ModePos": "Operating Mode",
      "Position": "Target Position (LU)",
      "Velocity": "Target Velocity (Overrides P2571)",
      "EnableAxis": "Power On"
    },
    "Outputs": {
      "ActMode": "Current active mode",
      "ActPosition": "Actual Position (LU)",
      "ActVelocity": "Actual Velocity (Normalized 40000000h = 100%)",
      "AxisRef": "Homed Status"
    }
  },
  "L2_Positioning_EPOS_Machine": {
    "description": "Aggregator L2 for EPOS Positioning. Orchestrates SinaPos, Safety, and optional components.",
    "structure": {
      "S120_SinaPos": "L1_SinaPos instance (Drive Interface)",
      "Fan_M": "Optional Motor Fan control",
      "RW_SINAMICS_Par": "Helpers to read/write specific drive parameters (P2507, P0971, Limits)"
    },
    "Mechanical_Calculation": "Calc_RedutionRatio function derives 'ReductionRatio' from Load/Motor revolutions and LeadScrew pitch. Usod to convert standard Drive Units (LU/RPM) into Application Units (mm, degrees).",
    "Homing_Strategy": {
      "Standard": "Via SinaPos Mode 4 or 5",
      "Direct_Preset": "Writes P2507/RefPos directly if 'Encoder_Inc_AutoReloadPosition' or 'Encoder_is_Absolute' is configured. Complex state machine ('Reload Position') handles persistent position restoration."
    },
    "Position_Limits": {
      "Source": "Reads Software Limits from Drive P2580/P2581.",
      "Logic": "Also supports PLC-side check against External Limits (CIn.PositionLimits) and updates general Min/Max allowable targets dynamically."
    },
    "Config": {
      "Ax": {
        "LeadScrewPitchVal": "Distance per revolution",
        "MotorRevolution/LoadRevolution": "Gearbox ratio",
        "MaxRPM_S120_P2000": "Reference Speed (100%)",
        "SwLimMinus/Plus_S120_P2580/1": "Software Limits to sync with Drive"
      },
      "Brake_Presence": "If true, enforces 0 velocity when brake is engaged"
    },
    "Alarms": {
      "S120_Fault": "Drive Fault (Active Fault in SinaPos)",
      "S120_ComErr": "Communication Error with Drive",
      "BrakeTimeOut": "Brake feedback mismatch",
      "Ax_NotHomed": "Move requested but AxisRef is FALSE",
      "S120_WriteParErr": "Failure in Writing parameters to drive"
    }
  },
  "Helpers": {
    "RW_SINAMICS_Par": "Custom wrapper around SinaParaS (System Block) to read/write Drive Parameters acyclically.",
    "Calc_RedutionRatio": "Computes gear ratio and screw pitch factor."
  },
  "L3_Integration_Patterns": {
    "passthrough_direct": {
      "description": "L3 passes Manager stop enables and Config/Alarm/Warning without modification",
      "scl_pattern": "t_CIn_{Instance}.Manager.EnableStopInPhase := CIn.Manager.EnableStopInPhase;"
    },
    "broadcast_shared": {
      "description": "Broadcast AreaInterface and ZSI/DSI to all instances",
      "scl_pattern": "t_CIn_{Instance}.AreaInterface := AreaInterface;"
    },
    "ext_enable": {
      "description": "ExtEnable derived from other device states or set TRUE if no interlock",
      "scl_pattern": "t_CIn_{Instance}.Fwd_ExtEnable := TRUE;"
    },
    "aggregation_rules": {
      "description": "Aggregate COut signals with AND/OR as required",
      "scl_pattern": "COut.AllStandstill := Inst1.COut.Standstill AND Inst2.COut.Standstill;"
    },
    "drive_tokenchain_mapping": {
      "description": "Mapping drive -> CU chain, position and HW_ID for parameter access",
      "rules": [
        "TokenChain selects the CU chain (TOKENCHAIN_CU1..TOKENCHAIN_CU8).",
        "AxisID/AxisNo is the drive position inside the CU (Token_CONST: CUx_ID_y_*).",
        "AccessPoint is the HW_ID of the CU from TIA hardware config.",
        "All three must match the electrical schema and CU parameterization."
      ],
      "scl_example": [
        "// Example for a drive on CU6, position 4",
        "t_CIn_EPOS1.Drive.AccessPoint := <HWID_CU6>;",
        "t_CIn_EPOS1.Drive.TokenChain := TOKENCHAIN_CU6;",
        "t_CIn_EPOS1.Drive.AxisID := CU6_ID_4_2100A1_1_2100M1;"
      ],
      "source_files": [
        "TokenChain_FC.scl",
        "GetToken.scl",
        "RW_SINAMICS_Par.scl",
        "Token_CONST.xml/Token_CONST.csv"
      ],
      "notes": [
        "TokenChain_FC is called in System_CALL to advance tokens.",
        "GetToken serializes RW_SINAMICS_Par per CU."
      ]
    }
  },
  "L3_Validation_Checklist": {
    "inputs": "Required inputs provided and mapped",
    "safety": "AreaInterface/ZSI/DSI wired and consistent",
    "aggregation": "COut aggregation implemented as specified",
    "commands": "Manager/Manual commands mapped without conflicts"
  },
  "Standard_Schema": {
    "Schema_Version": "1.0",
    "Standard_Sections": [
      "meta",
      "Precondizioni",
      "Variabili_Globali",
      "L1",
      "L2",
      "L3",
      "Pattern_Integrazione_L3",
      "Matrice_Responsabilita",
      "Errori_Comuni_L3",
      "Checklist_Validazione_L3"
    ],
    "Note": "Le sezioni italiane sono alias delle sezioni tecniche esistenti; usare i contenuti piu dettagliati presenti nel file."
  },
  "TODO_Strategy": {
    "goal": "Allow first pass code generation to compile in TIA while leaving TODOs for missing mappings.",
    "rules": [
      "Use TODOs only in comments, never as placeholder variable names.",
      "Always assign a safe default value so the code compiles.",
      "Resolve TODOs in a second pass by replacing the full assignment line."
    ],
    "safe_defaults": {
      "Bool": "FALSE",
      "LReal": "0.0",
      "Int/UInt": "0"
    },
    "example_block": [
      "// TODO: Map real device command",
      "t_CIn_Device.Manager.Control_ON := FALSE;",
      "// TODO: Map real setpoint",
      "t_CIn_Device.Manager.Vel := 0.0;"
    ]
  }
}